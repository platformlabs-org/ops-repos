name: Sync Subdirectories

on:
  push:
    branches:
      - main
      - master

jobs:
  sync:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - dir: whql
            repo: ops.platformlabs.lenovo.com/platform-drivers/whql
          - dir: dua
            repo: ops.platformlabs.lenovo.com/platform-drivers/dua
          - dir: sign
            repo: ops.platformlabs.lenovo.com/platform-drivers/sign
          - dir: bsod
            repo: ops.platformlabs.lenovo.com/operations/bsod
          - dir: windows-update
            repo: ops.platformlabs.lenovo.com/platform-drivers/windows-update
    steps:
      - uses: actions/checkout@v3

      - name: Sync to remote
        env:
          USERNAME: bot
          TOKEN: ${{ secrets.SYNC_TOKEN }}
          TARGET_REPO: ${{ matrix.repo }}
          DIR: ${{ matrix.dir }}
        run: |
          set -euo pipefail

          if [ ! -d "$DIR" ]; then
            echo "Directory $DIR does not exist. Skipping."
            exit 0
          fi

          echo "Syncing $DIR to $TARGET_REPO"

          WORK_DIR=$(mktemp -d)
          REMOTE_URL="https://${USERNAME}:${TOKEN}@${TARGET_REPO}"

          echo "Pulling from $TARGET_REPO"
          git clone "$REMOTE_URL" "$WORK_DIR"
          cd "$WORK_DIR"

          git config user.email "i@terry.ee"
          git config user.name "tianyi"

          git checkout main 2>/dev/null || git checkout -b main

          echo "Removing all existing files..."
          find . -mindepth 1 -maxdepth 1 ! -name '.git' -exec rm -rf {} +

          echo "Copying files from $DIR"
          cp -r "${GITHUB_WORKSPACE}/$DIR"/. .

          git add -A

          if git diff --cached --quiet; then
            echo "No changes detected. Skipping commit and push."
            exit 0
          fi

          echo "Changes detected. Committing and pushing..."
          git commit -m "Sync from remote repository"

          echo "Pushing to $TARGET_REPO"
          git push "$REMOTE_URL" HEAD:main