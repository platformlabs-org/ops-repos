name: Sync Subdirectories

on:
  push:
    branches:
      - main
      - master

jobs:
  sync:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - dir: whql
            repo: ops.platformlabs.lenovo.com/platform-drivers/whql
          - dir: dua
            repo: ops.platformlabs.lenovo.com/platform-drivers/dua
          - dir: sign
            repo: ops.platformlabs.lenovo.com/platform-drivers/sign
          - dir: bsod
            repo: ops.platformlabs.lenovo.com/operations/bsod
          - dir: tools
            repo: ops.platformlabs.lenovo.com/operations/tools
    steps:
      - uses: actions/checkout@v3

      - name: Sync to remote
        env:
          USERNAME: bot
          TOKEN: ${{ secrets.SYNC_TOKEN }}
          TARGET_REPO: ${{ matrix.repo }}
          DIR: ${{ matrix.dir }}
        run: |
          # Check if directory exists
          if [ ! -d "$DIR" ]; then
            echo "Directory $DIR does not exist. Skipping."
            exit 0
          fi

          echo "Syncing $DIR to $TARGET_REPO"

          # Create a temporary directory for the work
          WORK_DIR=$(mktemp -d)

          # Construct the remote URL with credentials
          REMOTE_URL="https://${USERNAME}:${TOKEN}@${TARGET_REPO}"

          # Clone the remote repository
          echo "Pulling from $TARGET_REPO"
          git clone "$REMOTE_URL" "$WORK_DIR"

          # Switch to the repository directory
          cd "$WORK_DIR"

          # Configure git user if not already configured
          git config user.email "i@terry.ee"
          git config user.name "tianyi"

          # Copy contents from the source directory, overwriting existing files
          echo "Copying files from $DIR"
          cp -r "${GITHUB_WORKSPACE}/$DIR"/. .

          # Check if there are any changes
          if git diff --quiet && git diff --cached --quiet; then
            echo "No changes detected. Skipping commit and push."
            exit 0
          fi

          echo "Changes detected. Committing and pushing..."

          # Add all files
          git add .

          # Create a commit
          git commit -m "Sync from remote repository"

          # Push to the remote repository
          echo "Pushing to $TARGET_REPO"
          git push "$REMOTE_URL" main:main
