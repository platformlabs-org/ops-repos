name: Sync Subdirectories

on:
  push:
    branches:
      - main
      - master

jobs:
  sync:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - dir: whql
            repo: ops.platformlabs.lenovo.com/platform-drivers/whql
          - dir: dua
            repo: ops.platformlabs.lenovo.com/platform-drivers/dua
          - dir: sign
            repo: ops.platformlabs.lenovo.com/platform-drivers/sign
          - dir: bsod
            repo: ops.platformlabs.lenovo.com/workflows/bsod
    steps:
      - uses: actions/checkout@v3

      - name: Push to remote
        env:
          USERNAME: ${{ secrets.SYNC_USERNAME }}
          TOKEN: ${{ secrets.SYNC_TOKEN }}
          TARGET_REPO: ${{ matrix.repo }}
          DIR: ${{ matrix.dir }}
        run: |
          # Check if directory exists
          if [ ! -d "$DIR" ]; then
            echo "Directory $DIR does not exist. Skipping."
            exit 0
          fi

          echo "Syncing $DIR to $TARGET_REPO"

          # Create a temporary directory for the fresh repo
          WORK_DIR=$(mktemp -d)

          # Copy contents of the subdirectory to the temporary directory
          # Using cp -r "$DIR"/. to include hidden files
          cp -r "$DIR"/. "$WORK_DIR"

          # Switch to the temporary directory
          cd "$WORK_DIR"

          # Initialize a new git repository
          git init
          # Default branch name for the new repo
          git checkout -b main

          # Configure git user
          git config user.email "action@github.com"
          git config user.name "GitHub Action"

          # Add all files
          git add .

          # Create a fresh commit
          # Using a generic message to avoid leaking source info
          git commit -m "Sync content from parent repository"

          # Construct the remote URL with credentials
          REMOTE_URL="https://${USERNAME}:${TOKEN}@${TARGET_REPO}"

          echo "Pushing to $TARGET_REPO"
          # Force push to overwrite remote history with this single commit
          git push "$REMOTE_URL" main:main --force
